{% extends 'global/base.html' %}
{% load static %}

{% block title %}Изменение пароля - Phantom{% endblock %}
{% block description %}Измените пароль для вашего аккаунта в стрелковом клубе Phantom.{% endblock %}

{% block content %}
<main class="main-content">
    <div class="container">
        <div class="auth-wrapper">
            <div class="auth-card card">
                <div class="auth-header text-center">
                    <div class="auth-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <h2>Изменение пароля</h2>
                    <p>Обновите пароль для повышения безопасности аккаунта</p>
                </div>
                
                <form method="post" class="auth-form" id="changePasswordForm">
                    {% csrf_token %}
                    
                    {% if form.errors or form.non_field_errors %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle"></i>
                            <div class="error-list">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <div>{{ field.label }}: {{ error }}</div>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="id_old_password" class="form-label">
                            <i class="fas fa-lock"></i>
                            Текущий пароль
                        </label>
                        <div class="password-input-wrapper">
                            <input 
                                type="password" 
                                name="old_password" 
                                id="id_old_password" 
                                class="form-control"
                                placeholder="Введите текущий пароль"
                                required
                                autocomplete="current-password"
                            >
                            <button type="button" class="password-toggle" onclick="togglePassword('id_old_password')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_new_password1" class="form-label">
                            <i class="fas fa-key"></i>
                            Новый пароль
                        </label>
                        <div class="password-input-wrapper">
                            <input 
                                type="password" 
                                name="new_password1" 
                                id="id_new_password1" 
                                class="form-control"
                                placeholder="Придумайте новый пароль"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" onclick="togglePassword('id_new_password1')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength"></div>
                        <small class="form-text">
                            Пароль должен содержать минимум 8 символов, включая буквы и цифры
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_new_password2" class="form-label">
                            <i class="fas fa-check"></i>
                            Подтверждение нового пароля
                        </label>
                        <div class="password-input-wrapper">
                            <input 
                                type="password" 
                                name="new_password2" 
                                id="id_new_password2" 
                                class="form-control"
                                placeholder="Повторите новый пароль"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" onclick="togglePassword('id_new_password2')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-match" id="passwordMatch"></div>
                    </div>
                    
                    <!-- Security Tips -->
                    <div class="security-tips">
                        <h4>
                            <i class="fas fa-shield-alt"></i>
                            Рекомендации по безопасности
                        </h4>
                        <ul>
                            <li>Используйте уникальный пароль для каждого аккаунта</li>
                            <li>Включите двухфакторную аутентификацию</li>
                            <li>Не используйте личную информацию в пароле</li>
                            <li>Регулярно обновляйте пароли</li>
                        </ul>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-block" id="changePasswordBtn">
                            <i class="fas fa-save"></i>
                            Изменить пароль
                        </button>
                    </div>
                    
                    <div class="auth-links text-center">
                        <p>
                            <a href="{% url 'cabinet' %}" class="auth-link">
                                <i class="fas fa-arrow-left"></i>
                                Вернуться в кабинет
                            </a>
                        </p>
                        {% if not user.mfa_enabled %}
                        <p>
                            <a href="{% url 'authentication' %}" class="auth-link">
                                <i class="fas fa-shield-alt"></i>
                                Настроить двухфакторную аутентификацию
                            </a>
                        </p>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    const strengthIndicator = document.getElementById('passwordStrength');
    const matchIndicator = document.getElementById('passwordMatch');
    
    // Password strength checker
    newPassword1.addEventListener('input', function() {
        const password = this.value;
        const strength = checkPasswordStrength(password);
        
        strengthIndicator.className = `password-strength ${strength.class}`;
        strengthIndicator.textContent = strength.text;
        
        checkPasswordMatch();
    });
    
    // Password match checker
    newPassword2.addEventListener('input', checkPasswordMatch);
    
    function checkPasswordStrength(password) {
        if (password.length === 0) {
            return { class: '', text: '' };
        }
        
        let score = 0;
        const checks = {
            length: password.length >= 8,
            lowercase: /[a-z]/.test(password),
            uppercase: /[A-Z]/.test(password),
            numbers: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        Object.values(checks).forEach(check => check && score++);
        
        if (score < 2) return { class: 'weak', text: 'Слабый пароль' };
        if (score < 4) return { class: 'medium', text: 'Средний пароль' };
        return { class: 'strong', text: 'Надежный пароль' };
    }
    
    function checkPasswordMatch() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;
        
        if (password2.length === 0) {
            matchIndicator.className = 'password-match';
            matchIndicator.textContent = '';
            return;
        }
        
        if (password1 === password2) {
            matchIndicator.className = 'password-match match';
            matchIndicator.textContent = 'Пароли совпадают';
        } else {
            matchIndicator.className = 'password-match no-match';
            matchIndicator.textContent = 'Пароли не совпадают';
        }
    }
});
</script>
{% endblock %}